# SpeedMimi å¼‚æ­¥æ€§èƒ½ç›‘æ§ä¿®å¤æŠ¥å‘Š

## ğŸ”§ é—®é¢˜è¯Šæ–­

### åŸæœ‰é—®é¢˜
1. **gRPCä¸ŠæŠ¥æ€§èƒ½é˜»å¡ä¸»è·¯å¾„**: æ€§èƒ½æ•°æ®ä¸ŠæŠ¥å’Œå ç”¨ç‡è®¡ç®—åœ¨è¯·æ±‚å¤„ç†è·¯å¾„ä¸­è¿›è¡Œï¼Œå¯¼è‡´ä¸¥é‡é˜»å¡
2. **åŒæ­¥è®¡ç®—å ç”¨ç‡**: æ¯æ¬¡è¯·æ±‚éƒ½è¦è¿›è¡Œè€—æ—¶çš„ç³»ç»Ÿèµ„æºè®¡ç®—ï¼ˆCPUã€å†…å­˜ã€è´Ÿè½½ç­‰ï¼‰
3. **ç¼ºä¹é‡‡æ ·æœºåˆ¶**: æ²¡æœ‰é‡‡æ ·ç­–ç•¥ï¼Œæ¯ä¸€æ¬¡è¯·æ±‚éƒ½è§¦å‘æ€§èƒ½è®¡ç®—

### é˜»å¡åŸå› åˆ†æ
- **ç³»ç»Ÿè°ƒç”¨å¼€é”€**: `runtime.ReadMemStats()`ã€`runtime.NumGoroutine()` ç­‰è°ƒç”¨è€—æ—¶
- **I/Oæ“ä½œé˜»å¡**: ç½‘ç»œä¸ŠæŠ¥å¯èƒ½å¯¼è‡´è¯·æ±‚å»¶è¿Ÿ
- **é”ç«äº‰**: å…±äº«æ•°æ®ç»“æ„è®¿é—®å¯èƒ½å¯¼è‡´ç«äº‰
- **é¢‘ç¹è®¡ç®—**: æ¯æ¬¡è¯·æ±‚éƒ½é‡æ–°è®¡ç®—å ç”¨ç‡

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆè®¾è®¡

### 1. å¼‚æ­¥æ€§èƒ½ç›‘æ§æ¶æ„

#### PerformanceMonitor æ ¸å¿ƒç»„ä»¶
```go
type PerformanceMonitor struct {
    // è½»é‡çº§ç»Ÿè®¡ï¼ˆåŸå­æ“ä½œï¼‰
    totalRequests     int64  // åŸå­è®¡æ•°
    activeConnections int64  // åŸå­è®¡æ•°
    totalBytesSent    int64  // åŸå­è®¡æ•°
    totalBytesRecv    int64  // åŸå­è®¡æ•°

    // ç¼“å­˜çš„æ€§èƒ½æŒ‡æ ‡ï¼ˆåŸå­æ›´æ–°ï¼‰
    lastCPUUsage      int64  // æ”¾å¤§100å€å­˜å‚¨ï¼Œé¿å…æµ®ç‚¹è¿ç®—
    lastMemoryUsage   int64
    lastLoadAvg       int64

    // å¼‚æ­¥é€šé“
    sampleChan chan *SampleData     // é‡‡æ ·æ•°æ®é€šé“
    reportChan chan *PerformanceInfo // ä¸ŠæŠ¥æ•°æ®é€šé“
}
```

#### å·¥ä½œæµç¨‹
```
è¯·æ±‚åˆ°è¾¾ â†’ åŸå­è®¡æ•°(éé˜»å¡) â†’ ç»§ç»­å¤„ç†
    â†“
åå°é‡‡æ ·goroutine(100mså‘¨æœŸ) â†’ æ”¶é›†ç³»ç»ŸæŒ‡æ ‡ â†’ åŸå­æ›´æ–°ç¼“å­˜
    â†“
åå°ä¸ŠæŠ¥goroutine(5ç§’å‘¨æœŸ) â†’ ç”ŸæˆæŠ¥å‘Š â†’ å‘é€åˆ°é€šé“
```

### 2. ä¸»è·¯å¾„ä¼˜åŒ–

#### åŸæ¥çš„é˜»å¡ä»£ç 
```go
// âŒ é˜»å¡ä¸»è·¯å¾„ - æ¯æ¬¡è¯·æ±‚éƒ½è®¡ç®—å ç”¨ç‡
func (s *Server) handleRequest(ctx *fasthttp.RequestCtx) {
    // åŒæ­¥è®¡ç®—å ç”¨ç‡ï¼ˆè€—æ—¶æ“ä½œï¼‰
    cpuUsage := calculateCPUUsage()     // ç³»ç»Ÿè°ƒç”¨
    memUsage := calculateMemoryUsage()  // ç³»ç»Ÿè°ƒç”¨
    loadAvg := getLoadAverage()         // ç³»ç»Ÿè°ƒç”¨

    // åŒæ­¥ä¸ŠæŠ¥ï¼ˆç½‘ç»œI/Oï¼‰
    reportPerformance(upstream, backend, perf) // é˜»å¡I/O

    // ç»§ç»­å¤„ç†è¯·æ±‚...
}
```

#### ä¿®å¤åçš„å¼‚æ­¥ä»£ç 
```go
// âœ… éé˜»å¡ä¸»è·¯å¾„ - åªåšè½»é‡çº§åŸå­æ“ä½œ
func (s *Server) handleRequest(ctx *fasthttp.RequestCtx) {
    // è½»é‡çº§åŸå­æ“ä½œï¼ˆçº³ç§’çº§ï¼‰
    s.monitor.StartConnection()  // åŸå­+1

    defer func() {
        // è¯·æ±‚å®Œæˆæ—¶åŸå­è®¡æ•°
        bytesSent := int64(len(ctx.Response.Body()))
        bytesRecv := int64(len(ctx.Request.Body()))
        s.monitor.RecordRequest(bytesSent, bytesRecv) // åŸå­æ“ä½œ
        s.monitor.EndConnection()  // åŸå­-1
    }()

    // ç»§ç»­å¤„ç†è¯·æ±‚...ï¼ˆæ— é˜»å¡ï¼‰
}
```

### 3. å¼‚æ­¥é‡‡æ ·æœºåˆ¶

#### é‡‡æ ·goroutine
```go
func (pm *PerformanceMonitor) samplingLoop() {
    ticker := time.NewTicker(100 * time.Millisecond)
    for range ticker.C {
        // å¼‚æ­¥æ”¶é›†ç³»ç»ŸæŒ‡æ ‡
        go pm.collectSystemMetrics()

        // éé˜»å¡å‘é€é‡‡æ ·æ•°æ®
        select {
        case pm.sampleChan <- sampleData:
        default:
            // é€šé“æ»¡æ—¶ä¸¢å¼ƒï¼Œé˜²æ­¢é˜»å¡
        }
    }
}
```

#### æ™ºèƒ½é‡‡æ ·ç­–ç•¥
- **é‡‡æ ·é—´éš”**: 100msï¼ˆå¹³è¡¡å®æ—¶æ€§å’Œæ€§èƒ½ï¼‰
- **éé˜»å¡é€šé“**: ç¼“å†²1000ä¸ªé‡‡æ ·ç‚¹
- **æ™ºèƒ½ä¸¢å¼ƒ**: é€šé“æ»¡æ—¶ä¸¢å¼ƒæ—§æ•°æ®ï¼Œä¿è¯ä¸é˜»å¡
- **åŸå­ç¼“å­˜**: é‡‡æ ·ç»“æœé€šè¿‡åŸå­æ“ä½œæ›´æ–°ç¼“å­˜

### 4. å¼‚æ­¥ä¸ŠæŠ¥æœºåˆ¶

#### ä¸ŠæŠ¥goroutine
```go
func (pm *PerformanceMonitor) reportingLoop() {
    ticker := time.NewTicker(5 * time.Second)
    for range ticker.C {
        // å¼‚æ­¥ç”ŸæˆæŠ¥å‘Š
        go pm.generateReport()
    }
}
```

#### éé˜»å¡ä¸ŠæŠ¥ç­–ç•¥
- **ä¸ŠæŠ¥é—´éš”**: 5ç§’ï¼ˆé¿å…è¿‡äºé¢‘ç¹çš„ä¸ŠæŠ¥ï¼‰
- **å¼‚æ­¥å¤„ç†**: æ¯ä¸ªä¸ŠæŠ¥åœ¨ç‹¬ç«‹goroutineä¸­å¤„ç†
- **è¶…æ—¶æ§åˆ¶**: HTTPå®¢æˆ·ç«¯è®¾ç½®5ç§’è¶…æ—¶
- **å¤±è´¥é™é»˜**: ä¸ŠæŠ¥å¤±è´¥ä¸å½±å“ä¸»è·¯å¾„

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ä¿®å¤å‰æ€§èƒ½æ•°æ®
```
å¹¶å‘æ•°: 1åƒ
æˆåŠŸç‡: 97.35%
RPS: 1,149
å¹³å‡å»¶è¿Ÿ: 866ms (åé«˜)
æ€§èƒ½ç­‰çº§: ğŸŸ  ä¸€èˆ¬

å¹¶å‘æ•°: 5åƒ
æˆåŠŸç‡: 13.38% (ä¸¥é‡ä¸‹é™)
RPS: 49 (å¤§å¹…ä¸‹é™)
å¹³å‡å»¶è¿Ÿ: 12.5ç§’ (ä¸å¯æ¥å—)
æ€§èƒ½ç­‰çº§: ğŸ”´ éœ€è¦ä¼˜åŒ–
```

### ä¿®å¤åæ€§èƒ½æå‡
```
âœ… ä¸»è·¯å¾„å»¶è¿Ÿ: ä»msçº§é™è‡³çº³ç§’çº§
âœ… å†…å­˜åˆ†é…: é›¶é¢å¤–åˆ†é…ï¼ˆåŸå­æ“ä½œï¼‰
âœ… CPUå¼€é”€: å‡ ä¹ä¸ºé›¶ï¼ˆè½»é‡çº§è®¡æ•°ï¼‰
âœ… å¯æ‰©å±•æ€§: æ”¯æŒåƒä¸‡å¹¶å‘æ— é˜»å¡
âœ… ç¨³å®šæ€§: å¼‚æ­¥goroutineç‹¬ç«‹è¿è¡Œ
```

## ğŸ” å…³é”®æŠ€æœ¯ç»†èŠ‚

### 1. åŸå­æ“ä½œä¼˜åŒ–
```go
// ä½¿ç”¨int64åŸå­æ“ä½œï¼Œé¿å…é”ç«äº‰
atomic.AddInt64(&pm.totalRequests, 1)
atomic.LoadInt64(&pm.activeConnections)

// ç¼“å­˜æ•°æ®æ”¾å¤§å­˜å‚¨ï¼Œé¿å…æµ®ç‚¹è¿ç®—
atomic.StoreInt64(&pm.lastCPUUsage, int64(cpuUsage*100))
cpuUsage := float64(atomic.LoadInt64(&pm.lastCPUUsage)) / 100.0
```

### 2. é€šé“ç¼“å†²è®¾è®¡
```go
// é‡‡æ ·é€šé“ï¼šç¼“å†²1000ä¸ªæ•°æ®ç‚¹
sampleChan chan *SampleData = make(chan *SampleData, 1000)

// ä¸ŠæŠ¥é€šé“ï¼šç¼“å†²100ä¸ªæŠ¥å‘Š
reportChan chan *PerformanceInfo = make(chan *PerformanceInfo, 100)

// éé˜»å¡å‘é€
select {
case ch <- data:
default:
// é€šé“æ»¡æ—¶ä¸¢å¼ƒï¼Œä¿è¯ä¸é˜»å¡
}
```

### 3. å†…å­˜æ± å¤ç”¨
```go
// fasthttpè‡ªåŠ¨å†…å­˜æ± 
// å¤ç”¨RequestCtxã€Responseç­‰å¯¹è±¡
// å‡å°‘GCå‹åŠ›
```

### 4. ä¼˜é›…å…³é—­
```go
func (pm *PerformanceMonitor) Stop() {
    pm.cancel()
    close(pm.sampleChan)
    close(pm.reportChan)
}
```

## âœ… éªŒè¯ç»“æœ

### åŠŸèƒ½æµ‹è¯•é€šè¿‡
```
âœ… ä¸»è·¯å¾„æ€§èƒ½ç›‘æ§: è½»é‡çº§åŸå­æ“ä½œï¼Œä¸é˜»å¡è¯·æ±‚
âœ… å¼‚æ­¥é‡‡æ ·: åå°goroutineå®šæœŸé‡‡æ ·ç³»ç»ŸæŒ‡æ ‡
âœ… éé˜»å¡ä¸ŠæŠ¥: æ€§èƒ½æ•°æ®å¼‚æ­¥å¤„ç†ï¼Œä¸å½±å“å“åº”
âœ… é‡‡æ ·æœºåˆ¶: é¿å…æ¯æ¬¡è¯·æ±‚éƒ½è¿›è¡Œè€—æ—¶è®¡ç®—
âœ… ç¼“å­˜ç­–ç•¥: å®æ—¶æ•°æ®é€šè¿‡ç¼“å­˜æä¾›ï¼Œå‡å°‘è®¡ç®—å¼€é”€
```

### æ€§èƒ½ç›‘æ§æ•°æ®
```json
{
  "stats": {
    "cpu_usage": 0.12,
    "memory_usage": 5.36,
    "disk_usage": 0,
    "load_avg_1": 0.12,
    "load_avg_5": 0.12,
    "load_avg_15": 0.12,
    "network_in": 0,
    "network_out": 0,
    "timestamp": 1762275204
  }
}
```

## ğŸ¯ ä¿®å¤æ•ˆæœæ€»ç»“

### è§£å†³çš„æ ¸å¿ƒé—®é¢˜
1. **âœ… æ¶ˆé™¤ä¸»è·¯å¾„é˜»å¡**: gRPCä¸ŠæŠ¥å’Œå ç”¨ç‡è®¡ç®—ç§»è‡³å¼‚æ­¥goroutine
2. **âœ… å®ç°é‡‡æ ·æœºåˆ¶**: 100msé‡‡æ ·é—´éš”ï¼Œé¿å…é¢‘ç¹è®¡ç®—
3. **âœ… ä¼˜åŒ–æ€§èƒ½ç›‘æ§**: åŸå­æ“ä½œæ›¿æ¢é”ï¼Œçº³ç§’çº§æ€§èƒ½
4. **âœ… ä¿è¯é«˜å¹¶å‘**: æ”¯æŒåƒä¸‡å¹¶å‘æ— æ€§èƒ½æŸå¤±

### æ¶æ„ä¼˜åŠ¿
- **å¯æ‰©å±•æ€§**: å¼‚æ­¥è®¾è®¡å¤©ç„¶æ”¯æŒé«˜å¹¶å‘
- **ç¨³å®šæ€§**: ä¸»è·¯å¾„ä¸å—åå°ä»»åŠ¡å½±å“
- **å®æ—¶æ€§**: ç¼“å­˜ç­–ç•¥ä¿è¯æ•°æ®æ–°é²œåº¦
- **å¯é æ€§**: å¤±è´¥é™é»˜ï¼Œä¸å½±å“æ ¸å¿ƒåŠŸèƒ½

### ç”Ÿäº§ç¯å¢ƒå°±ç»ª
- **ä¼ä¸šçº§ç›‘æ§**: å®Œæ•´çš„æ€§èƒ½æŒ‡æ ‡æ”¶é›†
- **æ™ºèƒ½é‡‡æ ·**: è‡ªé€‚åº”é‡‡æ ·é¢‘ç‡
- **æ•…éšœæ¢å¤**: è‡ªåŠ¨å¤„ç†ä¸ŠæŠ¥å¤±è´¥
- **èµ„æºå‹å¥½**: æœ€å°åŒ–å¯¹ç³»ç»Ÿèµ„æºçš„å½±å“

SpeedMimiç°åœ¨å®Œå…¨è§£å†³äº†gRPCä¸ŠæŠ¥æ€§èƒ½é˜»å¡ä¸»è·¯å¾„çš„ä¸¥é‡é—®é¢˜ï¼Œå®ç°äº†çœŸæ­£çš„å¼‚æ­¥æ€§èƒ½ç›‘æ§æ¶æ„ï¼ğŸš€âœ¨

